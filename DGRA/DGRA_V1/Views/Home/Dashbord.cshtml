@using Newtonsoft.Json;
@using Microsoft.AspNetCore.Http;

@inject IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Home Page";
}
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
<!-- Font Awesome -->
<link rel="stylesheet" href="~/Content/theme/plugins/fontawesome-free/css/all.min.css">
<!-- daterange picker -->
<link rel="stylesheet" href="~/Content/theme/plugins/daterangepicker/daterangepicker.css">
<!-- DataTables -->
<link rel="stylesheet" href="~/Content/theme/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="~/Content/theme/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
<link rel="stylesheet" href="~/Content/theme/plugins/multiple-select/dist/multiple-select.min.css" />
<link rel="stylesheet" href="~/Content/theme/plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
@{
    string windSiteList = "";
    string solarSiteList = "";
    var usermodel = JsonConvert.DeserializeObject<UserAccess>(@HttpContextAccessor.HttpContext.Session.GetString("UserAccess"));

}
@for (int i = 0; i < @usermodel.access_list.Count; i++)
{

    if (@usermodel.access_list[i].page_type == 3 && @usermodel.access_list[i].site_type == 1)
    {
        windSiteList += @usermodel.access_list[i].identity.ToString() + ",";
    }
    if (@usermodel.access_list[i].page_type == 3 && @usermodel.access_list[i].site_type == 2)
    {
        solarSiteList += @usermodel.access_list[i].identity.ToString() + ",";
    }


}

<link href="~/Content/theme/dist/css/adminlte.css" rel="stylesheet" />
<div class="content-wrapper">
    <section class="content-header">
    </section>


    <section class="content">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title text-center">Dashboard</h3>

                <!--<div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button type="button" class="btn btn-tool" data-card-widget="remove" title="Remove">
                        <i class="fas fa-times"></i>
                    </button>
                </div>-->
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-sm-3">
                        <div class="input-group ">
                            <label class="col-sm-4 col-form-label text-right">FY : </label>
                            <select class="form-control  col-sm-8" id="fy" name="fy" value="">
                                <option value="">Please select </option>
                            </select>
                        </div>
                    </div>
                    <div class="col-sm-3">
                        <div class="form-group">
                            <div class="row">
                                <label class="col-sm-4 col-form-label text-right">Wind Site : </label>
                                <select class="form-control multi-select col-sm-8" id="wind_site" name="wind_site" multiple></select>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-3">
                        <div class="form-group">
                            <div class="row">
                                <label class="col-sm-4 col-form-label text-right">Solar Site : </label>
                                <select class="form-control multi-select col-sm-8" id="solar_site" name="solar_site" multiple></select>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-1"></div>
                    <div class="col-sm-2 text-center">
                        <button type="button" class="btn btn-block btn-primary" onclick="GetReport();" style=" width: 6rem;">Search</button>
                    </div>

                </div>
                <hr>
                <div class="row">
                    <div class="col-sm-6">
                        <div class="card tbl-head" style="max-height: 185px; height: 185px; width: 100%; padding: 1rem 1rem 0 0; border-radius: 3rem;">
                            <table style="border-collapse: collapse; width: 100%;">
                                <tbody>
                                    <tr style="border-bottom:2px solid lightgray">
                                        <td rowspan="2">
                                            <div style="width: 70%; float: left; text-align: center;">
                                                <img src="~/Content/img/image010.png" width="60" height="60" />
                                                <br><br><span>Wind <br><span id="total_mw"> (0 MW)</span></span>
                                            </div>
                                            <div style="width: 30%; float: left;">
                                                <img src="~/Content/img/image002.png" width="40" height="40" />
                                            </div>
                                        </td>
                                        <td>
                                            <span style="font-size:14px">Last Day Energy</span><br>
                                            <span style="font-size:15px" id="lastday_enrgy"><b> 0</b></span>
                                            <span style="font-size:12px">MWh</span><br>
                                            <span style="font-size:12px" id="lastday_enrgy_var">(0 %)</span><br>
                                        </td>
                                        <td>
                                            <span style="font-size:14px">MTD Energy</span><br>
                                            <span style="font-size:15px" id="manthly_enrgy"><b>0</b></span>
                                            <span style="font-size:12px">GWh</span><br>
                                            <span style="font-size:12px" id="manthly_enrgy_var">(0 %)</span><br>
                                        </td>
                                        <td>
                                            <span style="font-size:14px">YTD Energy</span><br>
                                            <span style="font-size:15px"  id="yearly_enrgy"><b>0</b></span>
                                            <span style="font-size:12px">GWh</span><br>
                                            <span style="font-size:12px" id="yearly_enrgy_var">(0 %)</span><br>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <span style="font-size:14px">Last Day Wind Speed</span><br>
                                            <span style="font-size:15px" id="lastday_wspeed"><b>0</b></span>
                                            <span style="font-size:12px">m/s</span><br>
                                            <span style="font-size:12px"  id="lastday_wspeed_var">(%)</span><br>
                                        </td>
                                        <td>
                                            <span style="font-size:14px">MTD Wind Speed</span><br>
                                            <span style="font-size:15px" id="monthly_wspeed"><b>0</b></span>
                                            <span style="font-size:12px">m/s</span><br>
                                            <span style="font-size:12px"  id="monthly_wspeed_var">(0 %)</span><br>
                                        </td>
                                        <td>
                                            <span style="font-size:14px">YTD Wind Speed</span><br>
                                            <span style="font-size:15px" id="yearly_wspeed"><b>0</b></span>
                                            <span style="font-size:12px">m/s</span><br>
                                            <span style="font-size:12px" id="yearly_wspeed_var">(0 %)</span><br>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- <img src="~/Content/img/image002.png" />-->
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="card tbl-head" style="max-height: 185px; height: 185px; width: 100%; padding: 1rem 1rem 0 0; border-radius: 3rem;">
                            <table style="border-collapse: collapse; width: 100%;">
                                <tbody>
                                    <tr style="border-bottom:2px solid lightgray">
                                        <td rowspan="2">
                                            <div style="width: 70%; float: left; text-align: center;">
                                                <img src="~/Content/img/image019.png" width="60" height="60" />
                                                <br><span>Solar <br><span id="total_ac_mw"> (0 MW)</span></span>
                                            </div>
                                            <div style="width: 30%; float: left;">
                                                <img src="~/Content/img/image020.png" width="40" height="40" />
                                            </div>
                                        </td>
                                        <td>
                                            <span style="font-size:14px">Last Day Energy </span><br>
                                            <span style="font-size:15px" id="lastday_solar_enrgy"><b>0</b></span>
                                            <span style="font-size:12px">MWh</span><br>
                                            <span style="font-size:12px" id="lastday_solar_enrgy_var">(0 %)</span><br>

                                        </td>
                                        <td>
                                            <span style="font-size:14px">MTD Energy </span><br>
                                            <span style="font-size:15px" id="monthly_solar_enrgy"><b>0</b></span>
                                            <span style="font-size:12px">GWh</span><br>
                                            <span style="font-size:12px" id="monthly_solar_enrgy_var">(0 %)</span><br>
                                        </td>
                                        <td>
                                            <span style="font-size:14px">YTD Energy </span><br>
                                            <span style="font-size:15px" id="yearly_solar_enrgy"><b>0</b></span>
                                            <span style="font-size:12px">GWh</span><br>
                                            <span style="font-size:12px" id="yearly_solar_enrgy_var">(0 %)</span><br>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td>
                                            <span style="font-size:14px">Last Day IR</span><br>
                                            <span style="font-size:15px"  id="lastday_ir"><b>0</b></span>
                                            <span style="font-size:12px">kWh/m<sup>2</sup></span><br>
                                            <span style="font-size:12px" id="lastday_ir_var">(0 %)</span><br>

                                        </td>
                                        <td>
                                            <span style="font-size:14px">MTD IR </span><br>
                                            <span style="font-size:15px"  id="monthly_ir"><b>0</b></span>
                                            <span style="font-size:12px">kWh/m<sup>2</sup></span><br>
                                            <span style="font-size:12px"  id="monthly_ir_var">(0 %)</span><br>
                                        </td>
                                        <td>
                                            <span style="font-size:14px">YTD IR </span><br>
                                            <span style="font-size:15px" id="yearly_ir"><b>0</b></span>
                                            <span style="font-size:12px">kWh/m<sup>2</sup></span><br>
                                            <span style="font-size:12px" id="yearly_ir_var">(0 %)</span><br>

                                        </td>
                                    </tr>
                                </tbody>
                            </table>


                        </div>
                    </div>
                </div>
                <hr>
                <div class="card-header">
                    <h3 class="card-title text-center">Generation Trend</h3>
                </div>
                <br>
                <div class="row">
                    <div class="col-sm-4">
                        <div class="form-group row">
                            <div class="col-sm-6">
                                <div class="custom-control custom-radio ">
                                    <input class="custom-control-input" type="radio" id="customRadio1" name="customRadio" onclick="chartSelection(1)" checked >
                                    <label for="customRadio1" class="custom-control-label" >Last 10 Days</label>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="custom-control custom-radio ">
                                    <input class="custom-control-input" type="radio" id="customRadio2" name="customRadio" onclick="chartSelection(2)" >
                                    <label for="customRadio2" class="custom-control-label">Monthly</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-8">
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-sm-6">

                        <canvas id="energy_wind" style="min-height: 400px; height: 400px; max-height: 400px; max-width: 100%; width: 560px;"></canvas>
                    </div>
                    <div class="col-sm-6">

                        <canvas id="energy_solar" style="min-height: 400px; height: 400px; max-height: 400px; max-width: 100%; width: 560px;"></canvas>
                    </div>
                </div>



            </div>


    </section>

</div>
<!-- /.content-wrapper -->
<script src="~/Content/theme/plugins/jquery/jquery.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="~/Content/theme/plugins/moment/moment.min.js"></script>
<script src="~/Content/theme/dist/js/comman.js"></script>
<script src="~/Content/theme/plugins/daterangepicker/daterangepicker.js" defer></script>
<script src="~/Content/theme/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>

<script src="~/Content/theme/plugins/summernote/summernote-bs4.min.js"></script>

<script src="~/Content/theme/plugins/chart.js/Chart.min.js"></script>
<script src="~/Content/theme/plugins/multiple-select/dist/multiple-select.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.0.0/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0-rc"></script>

<script type="text/javascript">
    var chartTitle = "";
    var fyear = "";
    var fdate = "";
    var monthdate = "";
    var month = "";
    //var tendays = "";
    window.onload = function () {
        getYear();
        getWindSite();
        getSolarSite();
       
        var today = new Date();
        fyear = getFinancialYear(today);

       
        fdate = getFinancialYearDate(fyear);
        console.log(fdate);
        monthdate = GetMonthDate(today);
        month = today.getMonth() + 1;
        
       tendays = GetLastTendays();
       
     }

    function getYear() {
        $.ajax({
            type: "GET",
            url: '@Url.Action("GetFinacialYear", "Dashboard")',
            //url: "/Dashboard/GetFinacialYear",
            contentType: "application/json; charset=utf-8",
            //data: '{"countryname":"' + selcountry + '"}',
            datatype: "html",
            success: function (result, status, xhr) {
                var options = "";
                options += '<option value="">Select Financial Year</option>';
                for (var i = 0; i < result.length; i++) {
                    if (result[i].financial_year == fyear) {
                        options += '<option value="' + result[i].financial_year + '" selected>' + result[i].financial_year + '</option>';
                    }
                    else {
                        options += '<option value="' + result[i].financial_year + '">' + result[i].financial_year + '</option>';
                    }

                }
                $("#fy").html(options);

            }
        });
    }
    function getWindSite() {
        var site_ids = "@Html.Raw(windSiteList.TrimEnd(','))";
        var wind_total_mw = 0;
        $.ajax({
            type: "GET",
           // url: "/Dashboard/GetWindSiteList",
            url: '@Url.Action("GetWindSiteList", "Dashboard")' + '?sitelist=' + site_ids,
            contentType: "application/json; charset=utf-8",
            datatype: "html",
            success: function (result, status, xhr) {
               // console.log(result);
                var options = "";
                for (var i = 0; i < result.length; i++) {
                    wind_total_mw += result[i].total_mw;
                    options += '<option value="' + result[i].site_master_id + '">' + result[i].site + '</option>';
                }
                $("#wind_site").html(options);
                $('#wind_site').multipleSelect({
                    "minimumCountSelected": 2,
                    "placeholder":"Select Wind Site(s)",
                });

                $('#wind_site').multipleSelect("setSelects", site_ids.split(","));
                document.getElementById("total_mw").innerHTML = "(" + wind_total_mw.toFixed(0) + " MW)";
                GetWindDataByLastDay();
                //GetWindDataByCurrentMonth();
                //GetWindDataByYearly();
                //if ($('#customRadio1').is(':checked')) {
                chartSelection(1);
               
               // }
            }
        });
    }
    function getSolarSite() {
        var site_ids = "@Html.Raw(solarSiteList.TrimEnd(','))";
        var solar_total_mw = 0;
        $.ajax({
            type: "GET",
            url: '@Url.Action("GetSolarSiteList", "Dashboard")' + '?sitelist=' + site_ids,
            contentType: "application/json; charset=utf-8",
            datatype: "html",
            success: function (result, status, xhr) {
               // console.log(result);
                var options = "";

                for (var i = 0; i < result.length; i++) {
                    solar_total_mw += result[i].ac_capacity;
                    options += '<option value="' + result[i].site_master_solar_id + '">' + result[i].site + '</option>';
                }
                $("#solar_site").html(options);
                $('#solar_site').multipleSelect({
                   "minimumCountSelected": 2,
                   "placeholder":"Select Solar Site(s)",
                });
                $('#solar_site').multipleSelect("setSelects", site_ids.split(","));
                document.getElementById("total_ac_mw").innerHTML = "(" + solar_total_mw.toFixed(0) + " MW)";
                GetSolarDataByLastDay();
               // GetSolarDataByCurrentMonth();
                //GetSolarDataByYearly();
                chartSelection(1);
               
            }
        });
    }

    function GetReport() {
        GetWindDataByLastDay();
        GetSolarDataByLastDay();
    }
    // Wind call
    function GetWindDataByLastDay() {

        let site = "";
         $('select#wind_site option:selected').each(function () {
            site += $(this).val() + ",";
           // console.log($(this).val());

         });
        site = site != "" ? site.slice(0, -1) : site;
        var FY = $('select#fy option:selected').val();
        var date = GetPreviousDate();
        //console.log("PeviousDate" + date);
        $.ajax({
            type: "GET",
            url: '@Url.Action("GetWindDashboardDataByLastDay", "Dashboard")' + '?FY=' + FY + '&sites=' + site + '&date=' + date,
            //url: "/Dashboard/GetWindDashboardDataByLastDay?FY=" + FY + "&sites=" + site + "&date=" + date,
            contentType: "application/json; charset=utf-8",
            //data: '{"countryname":"' + selcountry + '"}',
            datatype: "html",
            success: function (result, status, xhr) {
              // console.log(result);
                if (result.length > 0) {
                    var wind_lastday_energy = 0;
                    var wind_lastday_energy_target = 0;
                    var wind_lastday_wspeed = 0;
                    var wind_lastday_wspeed_target = 0;
                    var wcnt = 1;
                    var lastVariant_energy = 0;
                    var lastVariant_wspeed = 0;
                    for (var i = 0; i < result.length; i++) {
                        wind_lastday_energy += result[i].jmrkwh;
                        wind_lastday_wspeed += result[i].wind;
                        wind_lastday_energy_target += result[i].tarkwh;
                        wind_lastday_wspeed_target += result[i].tarwind;
                        wcnt++;
                    }
                    if (wind_lastday_energy_target != 0) {
                        lastVariant_energy = ((wind_lastday_energy - wind_lastday_energy_target) / wind_lastday_energy_target) / 100;
                    }
                    if (wind_lastday_wspeed_target != 0) {
                        lastVariant_wspeed = ((wind_lastday_wspeed - wind_lastday_wspeed_target) / wind_lastday_wspeed_target) / 100;
                    }
                    document.getElementById("lastday_enrgy").innerHTML = "<b>" + (wind_lastday_energy / 1000).toFixed(1) + "</b>";
                    document.getElementById("lastday_wspeed").innerHTML = "<b>" + (wind_lastday_wspeed / wcnt).toFixed(1) + "</b>";

                    document.getElementById("lastday_enrgy_var").innerHTML = "(" + lastVariant_energy.toFixed(1) + " %)";
                    document.getElementById("lastday_wspeed_var").innerHTML = "(" + lastVariant_wspeed.toFixed(1) + " %)";
                }
                else {
                    document.getElementById("lastday_enrgy").innerHTML = "<b>0.0</b>";
                    document.getElementById("lastday_wspeed").innerHTML = "<b>0.0</b>";

                    document.getElementById("lastday_enrgy_var").innerHTML = "(0 %)";
                    document.getElementById("lastday_wspeed_var").innerHTML = "(0 %)";

                }
                GetWindDataByCurrentMonth();
                
            }
        });
    }


    function GetWindDataByCurrentMonth() {

        let site = "";
        $('select#wind_site option:selected').each(function () {
            site += $(this).val() + ",";

        });
        site = site != "" ? site.slice(0, -1) : site;
        var startDate = monthdate.startdate;
        var endDate = GetPreviousDate();//monthdate.enddate;
        var FY = $('select#fy option:selected').val();

       // var month = month;
        $.ajax({
            type: "GET",
            url: '@Url.Action("GetWindDashboardDataByCurrentMonth", "Dashboard")' + '?startDate=' + startDate + '&endDate=' + endDate + '&FY=' + FY + '&sites=' + site + '&month=' + month,
            //url: "/Dashboard/GetWindDashboardDataByCurrentMonth?startDate=" + startDate + "&endDate=" + endDate + "&FY=" + FY + "&sites=" + site + "&month=" + month,
            contentType: "application/json; charset=utf-8",
            //data: '{"countryname":"' + selcountry + '"}',
            datatype: "html",
            success: function (result, status, xhr) {
                if (result.length > 0) {
                    var wind_monthly_energy = 0;
                    var wind_monthly_energy_target = 0;
                    var wind_monthly_wspeed = 0;
                    var wind_monthly_wspeed_target = 0;
                    var monthly_var_energy = 0;
                    var monthly_var_wspeed = 0;
                    var wcnt = 0;
                    for (var i = 0; i < result.length; i++) {
                        wind_monthly_energy += result[i].jmrkwh;
                        wind_monthly_wspeed += result[i].wind;
                        wind_monthly_energy_target += result[i].tarkwh;
                        wind_monthly_wspeed_target += result[i].tarwind;
                        wcnt++;
                    }
                    console.log(wind_monthly_wspeed);
                    console.log(wcnt);
                    if (wind_monthly_energy_target != 0) {
                        monthly_var_energy = ((wind_monthly_energy - wind_monthly_energy_target) / wind_monthly_energy_target)*100;
                    }
                    if (wind_monthly_wspeed_target != 0) {
                        monthly_var_wspeed = ((wind_monthly_wspeed - wind_monthly_wspeed_target) / wind_monthly_wspeed_target)* 100;
                    }
                    document.getElementById("manthly_enrgy").innerHTML = "<b>" + (wind_monthly_energy / 1000000).toFixed(1) + "</b>";
                    document.getElementById("monthly_wspeed").innerHTML = "<b>" + (wind_monthly_wspeed / wcnt).toFixed(1) + "</b>";

                    document.getElementById("manthly_enrgy_var").innerHTML = "(" + monthly_var_energy.toFixed(1) + " %)";
                    document.getElementById("monthly_wspeed_var").innerHTML = "(" + monthly_var_wspeed.toFixed(1) + " %)";
                }
                else {
                    document.getElementById("manthly_enrgy").innerHTML = "<b>0.0</b>";
                    document.getElementById("monthly_wspeed").innerHTML = "<b>0.0</b>";

                    document.getElementById("manthly_enrgy_var").innerHTML = "(0 %)";
                    document.getElementById("monthly_wspeed_var").innerHTML = "(0 %)";
                }
                GetWindDataByYearly();
            }
        });
    }

    function GetWindDataByYearly() {
        let site = "";
        $('select#wind_site option:selected').each(function () {
            site += $(this).val() + ",";

        });
        site = site != "" ? site.slice(0, -1) : site;
        var startDate = fdate.startdate;
        var endDate = GetPreviousDate();//fdate.enddate;
        var FY = $('select#fy option:selected').val();

        $.ajax({
            type: "GET",
            //url: "/Dashboard/GetWindDashboardDataByYearly?startDate=" + startDate + "&endDate=" + endDate + "&FY=" + FY + "&sites=" + site,
            url: '@Url.Action("GetWindDashboardDataByYearly", "Dashboard")' + '?startDate=' + startDate + '&endDate=' + endDate + '&FY=' + FY + '&sites=' + site,
            contentType: "application/json; charset=utf-8",
            //data: '{"countryname":"' + selcountry + '"}',
            datatype: "html",
            success: function (result, status, xhr) {
                if (result.length > 0) {
                    var wind_yearly_energy = 0;
                    var wind_yearly_wspeed = 0;
                    var wind_yearly_energy_target = 0;
                    var wind_yearly_wspeed_target = 0;

                    var yearly_var_energy = 0;
                    var yearly_var_wspeed = 0;
                    var wcnt = 0;
                    for (var i = 0; i < result.length; i++) {
                        wind_yearly_energy += result[i].jmrkwh;
                        wind_yearly_wspeed += result[i].wind;
                        wind_yearly_energy_target += result[i].tarkwh;
                        wind_yearly_wspeed_target += result[i].tarwind;

                        wcnt++;
                    }
                    if (wind_yearly_energy_target != 0) {
                        yearly_var_energy = ((wind_yearly_energy - wind_yearly_energy_target) / wind_yearly_energy_target) * 100;
                    }
                    if (wind_yearly_wspeed_target != 0) {
                        yearly_var_wspeed = ((wind_yearly_wspeed - wind_yearly_wspeed_target) / wind_yearly_wspeed_target) * 100;
                    }
                    //console.log(result);
                    document.getElementById("yearly_enrgy").innerHTML = "<b>" + (wind_yearly_energy / 1000000).toFixed(1) + "</b>";
                    document.getElementById("yearly_wspeed").innerHTML = "<b>" + (wind_yearly_wspeed / wcnt).toFixed(1) + "</b>";

                    document.getElementById("yearly_enrgy_var").innerHTML = "(" + yearly_var_energy.toFixed(1) + " %)";
                    document.getElementById("yearly_wspeed_var").innerHTML = "(" + yearly_var_wspeed.toFixed(1) + " %)";
                }
                else {
                    document.getElementById("yearly_enrgy").innerHTML = "<b>0.0</b>";
                    document.getElementById("yearly_wspeed").innerHTML = "<b>0.0</b>";

                    document.getElementById("yearly_enrgy_var").innerHTML = "(0 %)";
                    document.getElementById("yearly_wspeed_var").innerHTML = "(0 %)";
                }
               
                
            }
        });
    }


   
    // Solar call
    function GetSolarDataByLastDay() {
        let solar_site = "";
        $('select#solar_site option:selected').each(function () {
            solar_site += $(this).val() + ",";
            //console.log($(this).val());

        });
        solar_site = solar_site != "" ? solar_site.slice(0, -1) : solar_site;

        var FY = $('select#fy option:selected').val();
        var date = GetPreviousDate();
        $.ajax({
            type: "GET",
           // url: "/Dashboard/GetSolarDashboardDataByLastDay?FY=" + FY + "&sites=" + solar_site + "&date=" + date,
            url: '@Url.Action("GetSolarDashboardDataByLastDay", "Dashboard")' + '?FY=' + FY + '&sites=' + solar_site + '&date=' + date,
            contentType: "application/json; charset=utf-8",
            //data: '{"countryname":"' + selcountry + '"}',
            datatype: "html",
            success: function (result, status, xhr) {
                if (result.length > 0) {
                    var lastday_energy = 0;
                    var lastday_ir = 0;
                    var lastday_energy_tar = 0;
                    var lastday_ir_tar = 0;
                    var lastday_var_energy = 0;
                    var lastday_var_ir = 0;
                    var cnt = 1;
                    for (var i = 0; i < result.length; i++) {
                        lastday_energy += result[i].jmrkwh;
                        lastday_ir += result[i].ir;
                        lastday_energy_tar += result[i].tarkwh;
                        lastday_ir_tar += result[i].tarir;

                        cnt++;
                    }
                    if (lastday_energy_tar != 0) {
                        lastday_var_energy = ((lastday_energy - lastday_energy_tar) / lastday_energy_tar) / 100;
                    }
                    if (lastday_ir_tar != 0) {
                        lastday_var_ir = ((lastday_ir - lastday_ir_tar) / lastday_ir_tar) / 100;
                    }
                    document.getElementById("lastday_solar_enrgy").innerHTML = "<b>" + ((lastday_energy) / 1000).toFixed(1) + "</b>";
                    document.getElementById("lastday_ir").innerHTML = "<b>" + (lastday_ir / cnt).toFixed(1) + "</b>";
                    document.getElementById("lastday_solar_enrgy_var").innerHTML = "(" + lastday_var_energy.toFixed(1) + " %)";
                    document.getElementById("lastday_ir_var").innerHTML = "(" + lastday_var_ir.toFixed(1) + " %)";
                }
                else {
                    document.getElementById("lastday_solar_enrgy").innerHTML = "<b>0.0</b>";
                    document.getElementById("lastday_ir").innerHTML = "<b>0.0</b>";
                    document.getElementById("lastday_solar_enrgy_var").innerHTML = "(0 %)";
                    document.getElementById("lastday_ir_var").innerHTML = "(0 %)";
                }

                GetSolarDataByCurrentMonth();
            }
        });
    }

    function GetSolarDataByCurrentMonth() {

        let solar_site = "";
        $('select#solar_site option:selected').each(function () {
            solar_site += $(this).val() + ",";

        });
        solar_site = solar_site != "" ? solar_site.slice(0, -1) : solar_site;

        var startDate = monthdate.startdate;
        var endDate = GetPreviousDate();
        var FY = $('select#fy option:selected').val();

        $.ajax({
            type: "GET",
            //url: "/Dashboard/GetSolarDashboardDataByCurrentMonth?startDate=" + startDate + "&endDate=" + endDate + "&FY=" + FY + "&sites=" + solar_site + "&month=" + month,
            url: '@Url.Action("GetSolarDashboardDataByCurrentMonth", "Dashboard")' + '?startDate=' + startDate + '&endDate=' + endDate + '&FY=' + FY + '&sites=' + solar_site + '&month=' + month,
            contentType: "application/json; charset=utf-8",
            //data: '{"countryname":"' + selcountry + '"}',
            datatype: "html",
            success: function (result, status, xhr) {
                if (result.length > 0) {
                    var monthly_energy = 0;
                    var monthly_ir = 0;
                    var monthly_energy_tar = 0;
                    var monthly_ir_tar = 0;
                    var monthly_var_energy = 0;
                    var monthly_var_ir = 0;
                    var cnt = 1;
                    for (var i = 0; i < result.length; i++) {
                        monthly_energy += result[i].jmrkwh;
                        monthly_ir += result[i].ir;
                        monthly_energy_tar += result[i].tarkwh;
                        monthly_ir_tar += result[i].tarir;
                        cnt++;
                    }
                    if (monthly_energy_tar != 0) {
                        monthly_var_energy = ((monthly_energy - monthly_energy_tar) / monthly_energy_tar) / 100;
                    }
                    if (monthly_ir_tar != 0) {
                        monthly_var_ir = ((monthly_ir - monthly_ir_tar) / monthly_ir_tar) / 100;
                    }

                    document.getElementById("monthly_solar_enrgy").innerHTML = "<b>" + ((monthly_energy) / 1000000).toFixed(1) + "</b>";
                    document.getElementById("monthly_ir").innerHTML = "<b>" + (monthly_ir / cnt).toFixed(1) + "</b>";
                    document.getElementById("monthly_solar_enrgy_var").innerHTML = "(" + monthly_var_energy.toFixed(1) + " %)";
                    document.getElementById("monthly_ir_var").innerHTML = "(" + monthly_var_ir.toFixed(1) + " %)";
                }
                else {
                    document.getElementById("monthly_solar_enrgy").innerHTML = "<b>0.0</b>";
                    document.getElementById("monthly_ir").innerHTML = "<b>0.0</b>";
                    document.getElementById("monthly_solar_enrgy_var").innerHTML = "(0 %)";
                    document.getElementById("monthly_ir_var").innerHTML = "(0 %)";
                }
               
            }
        });
        GetSolarDataByYearly();
    }

    function GetSolarDataByYearly() {
        let solar_site = "";
        $('select#solar_site option:selected').each(function () {
            solar_site += $(this).val() + ",";
            //console.log($(this).val());

        });
        solar_site = solar_site != "" ? solar_site.slice(0, -1) : solar_site;
        var startDate = fdate.startdate;
        var endDate = GetPreviousDate();
        var FY = $('select#fy option:selected').val();

        $.ajax({
            type: "GET",
            url: '@Url.Action("GetSolarDashboardDataByYearly", "Dashboard")' + '?startDate=' + startDate + '&endDate=' + endDate + '&FY=' + FY + '&sites=' + solar_site,
           //url: "/Dashboard/GetSolarDashboardDataByYearly?startDate=" + startDate + "&endDate=" + endDate + "&FY" + FY + "&sites=" + solar_site,
            contentType: "application/json; charset=utf-8",
            //data: '{"countryname":"' + selcountry + '"}',
            datatype: "html",
            success: function (result, status, xhr) {
                if (result.length > 0) {
                    var yearly_energy = 0;
                    var yeary_ir = 0;
                    var yearly_energy_tar = 0;
                    var yeary_ir_tar = 0;
                    var yearly_var_energy = 0;
                    var yearly_var_ir = 0;
                    var cnt = 1;
                    for (var i = 0; i < result.length; i++) {
                        yearly_energy += result[i].jmrkwh;
                        yeary_ir += result[i].ir;
                        yearly_energy_tar += result[i].tarkwh;
                        yeary_ir_tar += result[i].tarir;
                        cnt++;
                    }
                    if (yearly_energy_tar != 0) {
                        yearly_var_energy = ((yearly_energy - yearly_energy_tar) / yearly_energy_tar) / 100;
                    }
                    if (yeary_ir_tar != 0) {
                        yearly_var_ir = ((yeary_ir - yeary_ir_tar) / yeary_ir_tar) / 100;
                    }
                    document.getElementById("yearly_solar_enrgy").innerHTML = "<b>" + ((yearly_energy) / 1000000).toFixed(1) + "</b>";
                    document.getElementById("yearly_ir").innerHTML = "<b>" + (yeary_ir / cnt).toFixed(1) + "</b>";
                    document.getElementById("yearly_solar_enrgy_var").innerHTML = "(" + yearly_var_energy.toFixed(1) + " %)";
                    document.getElementById("yearly_ir_var").innerHTML = "(" + yearly_var_ir.toFixed(1) + " %)";
                }
                else {
                    document.getElementById("yearly_solar_enrgy").innerHTML = "<b>0.0</b>";
                    document.getElementById("yearly_ir").innerHTML = "<b>0.0</b>";
                    document.getElementById("yearly_solar_enrgy_var").innerHTML = "(0 %)";
                    document.getElementById("yearly_ir_var").innerHTML = "(0 %)";
                }

            }
        });
    }
    // chart 
    function chartSelection(type) {
        if (type == 1) {
            chartTitle = "Last 10 Days";
            GetWindChartData(tendays, chartTitle);
            GetSolarData(tendays, chartTitle);
        }
        if (type==2) {
            chartTitle = "Monthly";
            GetWindChartData(monthdate, chartTitle);
            GetSolarData(monthdate, chartTitle);
        }
    }

    function GetWindChartData(date_arr,title) {
        let site = "";
        $('select#wind_site option:selected').each(function () {
            site += $(this).val() + ",";
            // console.log($(this).val());

        });
        site = site != "" ? site.slice(0, -1) : site;
        console.log(date_arr);
        var startDate = date_arr.startdate;
        var endDate = date_arr.enddate;
        var FY = $('select#fy option:selected').val();
        var taget_wind = [];
        var actual_wind = [];
        var target_energy = [];
        var actual_energy = [];
        var datelebels = [];
        $.ajax({
            type: "GET",
            url: "/Dashboard/GetWindGraphData?startDate" + startDate + "&endDate=" + endDate + "&FY=" + FY + "&sites=" + site,
            contentType: "application/json; charset=utf-8",

            datatype: "html",
            success: function (result, status, xhr) {
                console.log(result)
                if (result.length > 0) {
                    let previous = "";
                    for (var w = 0; w < result.length; w++) {

                        var formattedDate = moment(result[w].date, 'YYYY-MM-DD').format('DD-MM-YYYY');
                        if (title == "Monthly") {
                            var oneDate = moment(formattedDate, 'DD-MM-YYYY');
                            var monthName = oneDate.format('MMMM');
                            
                            if (monthName != previous) {
                                datelebels.push(monthName);
                                previous = monthName;
                            }
                           
                        }
                        else {
                            datelebels.push(formattedDate);
                        }
                        
                        
                        taget_wind.push(result[w].tarwind.toFixed(2));
                        actual_wind.push(result[w].wind.toFixed(2));
                        target_energy.push((result[w].tarkwh/1000000).toFixed(2));
                        actual_energy.push((result[w].jmrkwh/1000000).toFixed(2));

                    }
                }

                windChart(title,datelebels, taget_wind, actual_wind, target_energy, actual_energy);
            }
        });

    }
    function windChart(title, datelebels, taget_wind, actual_wind, target_energy, actual_energy) {
        let chartStatus = Chart.getChart("energy_wind"); // <canvas> id
        if (chartStatus != undefined) {
            chartStatus.destroy();
        }
        new Chart(document.getElementById("energy_wind"), {
            type: 'bar',
            data: {
                labels: datelebels,
                datasets: [{

                    label: "Actual Wind",
                    type: "line",
                    borderColor: "#FFCA5A",
                    data: actual_wind,//[133, 221, 783, 2478, 133, 221, 783, 2478, 133, 221, 783, 2478],

                    fill: false,
                    //yAxisID: 'wind',
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                    },
                    /*datalabels: {
                        labels: {
                            title: null,
                        }
                    }*/
                }, {

                    label: "Target Wind",
                    type: "line",
                    borderColor: "#86C466",
                    data: taget_wind,//[408, 547, 675, 734, 408, 547, 675, 734, 408, 547, 675, 734],

                        fill: false,
                        //yAxisID: 'wind',
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                    },
                       /* datalabels: {
                            labels: {
                                title: null,
                            }
                        }*/

                    },
                    {

                        label: "Target Energy",
                        type: "bar",
                        backgroundColor: "#77CAE7",
                        data: target_energy,//[408, 547, 675, 734, 408, 547, 675, 734, 408, 547, 675, 734],
                        //yAxisID: 'energy',

                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                        },
                    }, {


                        label: "Actual Energy",
                        type: "bar",
                        backgroundColor: "#31576D",
                        backgroundColorHover: "#3e95cd",
                        data: actual_energy,//[133, 221, 783, 2478, 133, 221, 783, 2478, 133, 221, 783, 2478]
                        //yAxisID: 'energy',

                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                        },
                    }
                ]
            },
            //plugins: [ChartDataLabels],
            //options:
            //{
            //    title: {
            //        display: true,
            //        text: 'Monthly'
            //    },
            //    legend: {
            //        display: true,
            //        position: "bottom"
            //    },
            //    scales: {
            //        yAxes: [{
            //            id: 'energy',
            //            //type: 'linear',
            //            position: 'left',
            //            scaleLabel: {
            //                display: true,
            //                labelString: "Energy(MWh)",
            //                padding: 10,
            //                //fontColor: "#FFCA5A"

            //            }
            //        }, {
            //            id: 'wind',
            //            //type: 'linear',
            //            position: 'right',
            //            scaleLabel: {
            //                display: true,
            //                labelString: "Wind(m/s)",
            //                padding: 10,
            //                //fontColor: "#86C466"

            //            }
            //        }]
            //    },
            //    title: {
            //        display: true,
            //        text: title
            //    },
            //    legend: {
            //        display: true,
            //        position: "bottom"
            //    },

            //}

            plugins: [ChartDataLabels],
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: title
                    },

                    legend: {
                        display: true,
                        position: "bottom"
                    }

                }
            }
            
            //options: {
            //    scales: {

            //        yAxes: [{
            //            id: 'energy',
            //            //type: 'linear',
            //            position: 'left',
            //            scaleLabel: {
            //                display: true,
            //                labelString: "Energy(MWh)",
            //                padding: 10,
            //                //fontColor: "#FFCA5A"

            //            }
            //         }, {
            //            id: 'wind',
            //            //type: 'linear',
            //            position: 'right',
            //            scaleLabel: {
            //                display: true,
            //                labelString: "Wind(m/s)",
            //                padding: 10,
            //                //fontColor: "#86C466"

            //            }
            //        }]
            //    },
            //    title: {
            //        display: true,
            //        text: title
            //    },
            //    legend: {
            //        display: true,
            //        position: "bottom"
            //    },

            //}

            }
            );
    }


    function GetSolarData(date_arr, title) {
        let solar_site = "";
        $('select#solar_site option:selected').each(function () {
            solar_site += $(this).val() + ",";

        });
       
        solar_site = solar_site != "" ? solar_site.slice(0, -1) : solar_site;
        var startDate = date_arr.startdate;
        var endDate = date_arr.enddate;
        var FY = $('select#fy option:selected').val();
        var target_kwh = [];
        var actual_kwh = [];
        var target_ir = [];
        var actual_ir = [];
        var datelebels = [];
        $.ajax({
            type: "GET",
            url: "/Dashboard/GetSolarDashboardData?startDate=" + startDate + "&endDate=" + endDate + "&FY=" + FY + "&sites=" + solar_site,
            contentType: "application/json; charset=utf-8",
            //data: '{"countryname":"' + selcountry + '"}',
            datatype: "html",
            success: function (result, status, xhr) {
                console.log(result)
               if (result.length > 0) {
                    for (var s = 0; s < result.length; s++) {
                        var formattedDate = moment(result[s].date, 'YYYY-MM-DD').format('DD-MM-YYYY');
                        datelebels.push(formattedDate)
                        target_kwh.push((result[s].inv_kwh/1000000).toFixed(2));
                        actual_kwh.push((result[s].tarkwh /1000000).toFixed(2));
                        target_ir.push(result[s].tarIR.toFixed(2));
                        actual_ir.push(result[s].ir.toFixed(2));
                        //target_energy.push((result[w].tarkwh / 1000000).toFixed(2));
                        //actual_energy.push((result[w].jmrkwh / 1000000).toFixed(2));
                    }
                }

                solarChart(title,datelebels, target_kwh, actual_kwh, target_ir, actual_ir);

            }
        });
    }
    function solarChart(title, datelebels, target_kwh, actual_kwh, target_ir, actual_ir) {
        let chartStatus = Chart.getChart("energy_solar"); // <canvas> id
        if (chartStatus != undefined) {
            chartStatus.destroy();
        }
        new Chart(document.getElementById("energy_solar"), {
            type: 'bar',
            data: {
                labels: datelebels ,
                datasets: [{
                    label: "Target Energy",
                    type: "bar",
                    backgroundColor: "#77CAE7",
                    data: target_kwh,//[408, 547, 675, 734, 408, 547, 675, 734, 408, 547, 675, 734],
                    //yAxisID: 'energy',
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                    },
                }, {
                    label: "Actual Energy",
                    type: "bar",
                    backgroundColor: "#31576D",
                    backgroundColorHover: "#3e95cd",
                    data: actual_kwh,// [133, 221, 783, 2478, 133, 221, 783, 2478, 133, 221, 783, 2478]
                        //yAxisID: 'energy',
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                        },
                    },
                    {
                        label: "Target IR",
                        type: "line",
                        borderColor: "#86C466",
                        data: target_ir,//[408, 547, 675, 734, 408, 547, 675, 734, 408, 547, 675, 734],
                        fill: false,
                       /* datalabels: {
                            anchor: 'end',
                            align: 'top',
                        },*/
                        
                    }, {
                        label: "Actual IR",
                        type: "line",
                        borderColor: "#FFCA5A",
                        data: actual_ir,//[133, 221, 783, 2478, 133, 221, 783, 2478, 133, 221, 783, 2478],
                        fill: false,
                        /*datalabels: {
                            anchor: 'end',
                            align: 'top',
                        },*/
                        //yAxisID: 'ir',
                    }
                ]
            },
            plugins: [ChartDataLabels],
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: title
                    },

                    legend: {
                        display: true,
                        position: "bottom"
                    }

                }
            }
            //plugins: [ChartDataLabels],
            //options: {
            //    scales: {

            //        yAxes: [{
            //            id: 'energy',
            //            //type: 'linear',
            //            position: 'left',
            //            scaleLabel: {
            //                display: true,
            //                labelString: "Energy(MWh)",
            //                padding: 10,
            //                //fontColor: "#FFCA5A"

            //            }
            //        }, {
            //            id: 'ir',
            //            //type: 'linear',
            //            position: 'right',
            //            scaleLabel: {
            //                display: true,
            //                labelString: "IR(kWh/m<sup>2</sup>)",
            //                padding: 10,
            //                //fontColor: "#86C466"

            //            }
            //        }]
            //    },
            //    title: {
            //        display: true,
            //        text: title
            //    },
            //    legend: {
            //        display: true,
            //        position: "bottom"
            //    }
            //}
        });
    }
</script>